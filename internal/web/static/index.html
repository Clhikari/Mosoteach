<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mosoteach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="/css/style.css" />
    <script>
        (function () {
            const savedTheme = localStorage.getItem("theme") || "dark";
            document.documentElement.setAttribute("data-theme", savedTheme);
        })();
    </script>
</head>

<body>
    <div id="app" class="app-layout">
        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="authRequired && !authenticated" class="login-overlay">
            <div class="login-card">
                <div class="login-header">
                    <div class="login-logo">MosoHelper</div>
                    <div class="login-subtitle">è¯·è¾“å…¥è®¿é—®å¯†ç </div>
                </div>
                <form @submit.prevent="doAuthLogin" class="login-form">
                    <div class="form-item">
                        <input type="password" v-model="authPassword" class="input-block"
                            placeholder="è®¿é—®å¯†ç " autofocus />
                    </div>
                    <div v-if="authError" class="login-error">{{ authError }}</div>
                    <button type="submit" class="btn primary full" :disabled="authLoading">
                        {{ authLoading ? 'éªŒè¯ä¸­...' : 'ç™»å½•' }}
                    </button>
                </form>
            </div>
        </div>

        <!-- Toast æç¤º -->
        <div v-if="toast.show" :class="['toast', toast.type, { exiting: toast.exiting }]">
            {{ toast.message }}
        </div>

        <!-- å·¦ä¾§ä¾§è¾¹æ ï¼šå¯¼èˆªä¸æ ¸å¿ƒçŠ¶æ€ -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">MosoHelper</div>
                <div class="version">v2.0.0</div>
            </div>

            <div class="user-card">
                <div class="avatar-placeholder">
                    {{ (config.maskedUser[0] || 'U').toUpperCase() }}
                </div>
                <div class="user-details">
                    <div class="user-name">{{ config.maskedUser || 'æœªç™»å½•' }}</div>
                    <div class="user-status" :class="{ online: config.hasCookie }">
                        {{ config.hasCookie ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <button v-for="tab in tabs" :key="tab.id" :class="['nav-item', { active: currentTab === tab.id }]"
                    @click="currentTab = tab.id">
                    <span class="nav-icon">{{ tab.icon }}</span>
                    <span class="nav-label">{{ tab.name }}</span>
                </button>
            </nav>

            <div class="sidebar-footer">
                <button class="theme-toggle" @click="toggleTheme" :title="theme === 'dark' ? 'åˆ‡æ¢äº®è‰²' : 'åˆ‡æ¢æš—è‰²'">
                    {{ theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸' }}
                </button>
                <div class="sse-status" :class="{ connected: sseConnected }">
                    {{ sseConnected ? 'LINKED' : 'DISCONNECTED' }}
                </div>
            </div>
        </aside>

        <!-- ä¸­é—´ä¸»å·¥ä½œåŒº -->
        <main class="main-content">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <header class="top-bar">
                <h2 class="page-title">{{ currentTabName }}</h2>
                <div class="global-actions">
                    <button class="btn-icon" @click="loadStatus" title="åˆ·æ–°çŠ¶æ€">
                        ğŸ”„
                    </button>
                </div>
            </header>

            <!-- åŠ¨æ€å†…å®¹åŒº -->
            <div class="content-body">
                <!-- 1. è‡ªåŠ¨ç­”é¢˜è§†å›¾ -->
                <div v-show="currentTab === 'answer'" class="view-answer">
                    <div class="control-panel card">
                        <div class="panel-header">
                            <h3>æ§åˆ¶å°</h3>
                            <div class="status-badge" :class="{ running: status.running }">
                                {{ status.running ? 'è¿è¡Œä¸­' : 'ç©ºé—²' }}
                            </div>
                        </div>
                        <div class="panel-actions">
                            <button class="btn primary" @click="startAnswer" :disabled="status.running">
                                â–¶ {{ selectedQuiz.length > 0 ? 'ç­”é€‰ä¸­é¢˜åº“' : 'å¼€å§‹ç­”é¢˜' }}
                            </button>
                            <button class="btn secondary" @click="selectedQuiz = []" v-if="selectedQuiz.length > 0"
                                :disabled="status.running">
                                âœ• æ¸…ç©ºé€‰æ‹©
                            </button>
                            <button class="btn danger" @click="stopAnswer" :disabled="!status.running">
                                â¹ åœæ­¢
                            </button>
                            <button class="btn secondary" @click="doLogin" :disabled="status.running || loggingIn">
                                ğŸ”‘ ç™»å½•åˆ·æ–°
                            </button>
                        </div>
                        <div class="selected-quiz-hint" v-if="selectedQuiz.length > 0">
                            å·²é€‰æ‹©: {{ selectedQuizName }}
                        </div>
                        <div class="progress-block" v-if="status.total > 0 || status.running">
                            <div class="progress-labels">
                                <span>{{ status.message }}</span>
                                <span class="mono">{{ status.progress }}/{{ status.total }}</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-bar" :style="{ width: progressPercent + '%' }"></div>
                            </div>
                        </div>
                    </div>

                    <div class="quiz-panel card">
                        <div class="panel-header">
                            <h3>é¢˜åº“åˆ—è¡¨</h3>
                            <button class="btn-text" @click="loadQuizzes" :disabled="loadingQuizzes">
                                åˆ·æ–°
                            </button>
                        </div>
                        <div class="quiz-list-container">
                            <div v-if="loadingQuizzes" class="loading-state">åŠ è½½ä¸­...</div>
                            <div v-else-if="quizzes.length === 0" class="empty-state">
                                æš‚æ— é¢˜åº“æ•°æ®
                            </div>

                            <div v-else v-for="(courseQuizzes, courseName) in groupedQuizzes" :key="courseName"
                                class="course-section">
                                <div class="course-header">{{ courseName }}</div>
                                <div class="quiz-grid">
                                    <div v-for="quiz in courseQuizzes" :key="quiz.url"
                                        :class="['quiz-card', { completed: quiz.completed, selected: selectedQuiz.includes(quiz.url) }]"
                                        @click="selectQuiz(quiz)">
                                        <div class="quiz-icon">
                                            {{ quiz.completed ? 'âœ…' : 'ğŸ“' }}
                                        </div>
                                        <div class="quiz-info">
                                            <div class="quiz-name" :title="quiz.name">
                                                {{ quiz.name }}
                                            </div>
                                            <div class="quiz-meta" :title="'ID: ' + (quiz.quizId || 'Unknown')">
                                                ID: {{ (quiz.quizId || 'Unknown').substring(0, 8)
                                                }}...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. æ¨¡å‹é…ç½® -->
                <div v-show="currentTab === 'models'" class="view-models">
                    <div class="card">
                        <div class="panel-header">
                            <h3>AI æ¨¡å‹ç®¡ç†</h3>
                            <button class="btn primary small" @click="saveModels" :disabled="savingModels">
                                ä¿å­˜é…ç½®
                            </button>
                        </div>
                        <div class="models-grid">
                            <div v-for="(model, idx) in models" :key="idx" class="model-edit-card">
                                <div class="model-top">
                                    <input type="checkbox" v-model="model.enabled" class="switch" />
                                    <input type="text" v-model="model.name" class="input-ghost" placeholder="åˆ«å" />
                                    <button class="btn-icon danger" @click="removeModel(idx)">
                                        Ã—
                                    </button>
                                </div>
                                <div class="model-body">
                                    <div class="form-item">
                                        <label>Base URL</label>
                                        <input type="text" v-model="model.base_url" class="input-block" />
                                    </div>
                                    <div class="form-item">
                                        <label>Model Name</label>
                                        <input type="text" v-model="model.model" class="input-block" />
                                    </div>
                                    <div class="form-item">
                                        <label>API Key</label>
                                        <input type="password" v-model="model.api_key" class="input-block"
                                            :placeholder="model.has_api_key ? 'å·²ä¿å­˜' : 'è¾“å…¥Key'" />
                                    </div>
                                </div>
                                <div class="model-footer">
                                    <button class="btn secondary full" @click="testModel(idx)"
                                        :disabled="model.testing">
                                        {{ model.testing ? 'æµ‹è¯•ä¸­...' : 'è¿æ¥æµ‹è¯•' }}
                                    </button>
                                    <div v-if="model.testMessage" :class="['test-result', model.testResult]">
                                        {{ model.testResult === 'success' ? 'âœ”' : 'âœ˜' }} {{
                                        model.testMessage }}
                                    </div>
                                </div>
                            </div>
                            <div class="add-model-card" @click="addModel">
                                <span>+ æ·»åŠ æ–°æ¨¡å‹</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. è´¦å·é…ç½® -->
                <div v-show="currentTab === 'config'" class="view-config">
                    <div class="card config-card">
                        <h3>è´¦å·è®¾ç½®</h3>
                        <form @submit.prevent="saveConfig">
                            <div class="form-item">
                                <label>æ‰‹æœºå·</label>
                                <input type="text" v-model="configForm.user_name" class="input-block" />
                            </div>
                            <div class="form-item">
                                <label>å¯†ç </label>
                                <input type="password" v-model="configForm.password" class="input-block"
                                    placeholder="ä¸ä¿®æ”¹è¯·ç•™ç©º" />
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn primary" :disabled="saving">
                                    ä¿å­˜æ›´æ”¹
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="card config-card spaced">
                        <h3>ç­”é¢˜è®¾ç½®</h3>
                        <form @submit.prevent="saveSubmitDelay">
                            <div class="form-item">
                                <label>æäº¤å»¶è¿Ÿï¼ˆç§’ï¼‰</label>
                                <input type="number" v-model.number="submitDelay" class="input-block" min="0"
                                    placeholder="ç­”å®Œåç­‰å¾…çš„ç§’æ•°ï¼Œ0 è¡¨ç¤ºç«‹å³æäº¤" />
                                <small style="color: var(--text-muted); margin-top: 4px; display: block;">
                                    ç”¨äºéœ€è¦æœ€ä½ä½œç­”æ—¶é•¿çš„è€ƒè¯•ï¼Œç­”å®Œåä¼šå€’è®¡æ—¶ç­‰å¾…
                                </small>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn primary" :disabled="savingDelay">
                                    ä¿å­˜è®¾ç½®
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="card config-card spaced">
                        <h3>è®¿é—®æ§åˆ¶</h3>
                        <form @submit.prevent="saveWebPassword">
                            <div class="form-item">
                                <label>Web è®¿é—®å¯†ç </label>
                                <input type="password" v-model="webPassword" class="input-block"
                                    :placeholder="hasWebPassword ? 'å·²è®¾ç½®ï¼Œç•™ç©ºåˆ™ä¸ä¿®æ”¹' : 'è®¾ç½®åè®¿é—®éœ€è¦å¯†ç '" />
                                <small style="color: var(--text-muted); margin-top: 4px; display: block;">
                                    è®¾ç½®å¯†ç åï¼Œè®¿é—®ç½‘é¡µæ—¶éœ€è¦è¾“å…¥å¯†ç è®¤è¯ï¼ˆç”¨æˆ·åä»»æ„ï¼‰
                                </small>
                            </div>
                            <div class="form-actions" style="display: flex; gap: 8px;">
                                <button type="submit" class="btn primary" :disabled="savingPassword">
                                    ä¿å­˜å¯†ç 
                                </button>
                                <button type="button" class="btn secondary" @click="clearWebPassword"
                                    :disabled="savingPassword || !hasWebPassword">
                                    æ¸…é™¤å¯†ç 
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 5. è¿è¡Œæ—¥å¿— (ç‹¬ç«‹é¡µé¢) -->
                <div v-show="currentTab === 'logs'" class="view-logs">
                    <div class="card full-height-card">
                        <div class="panel-header">
                            <h3>SYSTEM TERMINAL</h3>
                            <button class="btn-icon" @click="logs = []" title="æ¸…ç©ºæ—¥å¿—">
                                ğŸ—‘
                            </button>
                        </div>
                        <div class="log-full-container" ref="logContainer">
                            <div v-for="(log, index) in logs" :key="index" :class="['log-line', log.type]">
                                <span class="ts">{{ log.time }}</span>
                                <span class="msg">{{ log.message }}</span>
                            </div>
                            <div v-if="logs.length === 0" class="log-placeholder">
                                > SYSTEM READY... WAITING FOR INPUT
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const {
            createApp,
            ref,
            reactive,
            computed,
            onMounted,
            onUnmounted,
            nextTick,
        } = Vue;

        createApp({
            setup() {
                const tabs = [
                    { id: "answer", name: "è‡ªåŠ¨ç­”é¢˜", icon: "ğŸš€" },
                    { id: "models", name: "æ¨¡å‹ç®¡ç†", icon: "ğŸ¤–" },
                    { id: "config", name: "ç³»ç»Ÿè®¾ç½®", icon: "âš™ï¸" },
                    { id: "logs", name: "è¿è¡Œæ—¥å¿—", icon: "ğŸ“œ" },
                ];
                const currentTab = ref("answer");
                const theme = ref(localStorage.getItem("theme") || "dark");

                // æ ¸å¿ƒæ•°æ®
                const config = reactive({ maskedUser: "", hasCookie: false });
                const configForm = reactive({ user_name: "", password: "" });
                const status = reactive({
                    running: false,
                    message: "Ready",
                    progress: 0,
                    total: 0,
                });
                const logs = ref([]);
                const quizzes = ref([]);
                const models = ref([]);

                // UI çŠ¶æ€
                const loadingQuizzes = ref(false);
                const saving = ref(false);
                const savingModels = ref(false);
                const loggingIn = ref(false);
                const selectedQuiz = ref([]); // æ”¹ä¸ºæ•°ç»„æ”¯æŒå¤šé€‰
                const sseConnected = ref(false);
                const logContainer = ref(null);
                const toast = reactive({ show: false, message: "", type: "success", exiting: false });
                const submitDelay = ref(0);
                const savingDelay = ref(false);
                const webPassword = ref("");
                const hasWebPassword = ref(false);
                const savingPassword = ref(false);

                // è®¤è¯ç›¸å…³
                const authRequired = ref(false);
                const authenticated = ref(true);
                const authPassword = ref("");
                const authLoading = ref(false);
                const authError = ref("");

                let eventSource = null;
                let statusInterval = null;
                let toastTimer = null;
                const currentTabName = computed(
                    () => tabs.find((t) => t.id === currentTab.value)?.name
                );
                const progressPercent = computed(() =>
                    status.total ? (status.progress / status.total) * 100 : 0
                );
                const selectedQuizName = computed(() => {
                    if (selectedQuiz.value.length === 0) return "";
                    if (selectedQuiz.value.length === 1) {
                        const quiz = quizzes.value.find(
                            (q) => q.url === selectedQuiz.value[0]
                        );
                        return quiz ? quiz.name : "æœªçŸ¥é¢˜åº“";
                    }
                    return `${selectedQuiz.value.length} ä¸ªé¢˜åº“`;
                });

                const groupedQuizzes = computed(() => {
                    const groups = {};
                    quizzes.value.forEach((q) => {
                        const name = q.courseName || "æœªåˆ†ç±»è¯¾ç¨‹";
                        if (!groups[name]) groups[name] = [];
                        groups[name].push(q);
                    });
                    return groups;
                });

                // ------------------------------------------------
                // æ–¹æ³•é›†
                // ------------------------------------------------
                const toggleTheme = () => {
                    theme.value = theme.value === "dark" ? "light" : "dark";
                    document.documentElement.setAttribute("data-theme", theme.value);
                    localStorage.setItem("theme", theme.value);
                };

                const addLog = (message, type = "") => {
                    logs.value.push({
                        time: new Date().toLocaleTimeString("en-US", { hour12: false }),
                        message,
                        type,
                    });
                    if (logs.value.length > 200) logs.value.shift();
                    nextTick(() => {
                        if (logContainer.value)
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                    });
                };

                const showToast = (message, type = "success") => {
                    if (toastTimer) clearTimeout(toastTimer);
                    toast.message = message;
                    toast.type = type;
                    toast.show = true;
                    toast.exiting = false;
                    toastTimer = setTimeout(() => {
                        toast.exiting = true;
                        setTimeout(() => {
                            toast.show = false;
                            toast.exiting = false;
                        }, 300); // Wait for animation
                    }, 3000);
                };

                // API è°ƒç”¨å°è£… (ç®€åŒ–ç‰ˆ)
                const apiCall = async (url, method = "GET", body = null) => {
                    try {
                        const opts = {
                            method,
                            headers: { "Content-Type": "application/json" },
                        };
                        if (body) opts.body = JSON.stringify(body);
                        const res = await fetch(url, opts);
                        return await res.json();
                    } catch (e) {
                        addLog(`API Error: ${e.message}`, "error");
                        throw e;
                    }
                };

                // ä¸šåŠ¡é€»è¾‘
                const checkAuth = async () => {
                    try {
                        const data = await apiCall("/api/auth/check");
                        authRequired.value = data.required;
                        authenticated.value = data.authenticated;
                    } catch (e) {
                        console.error("Auth check failed:", e);
                    }
                };

                const doAuthLogin = async () => {
                    authLoading.value = true;
                    authError.value = "";
                    try {
                        const res = await fetch("/api/auth/login", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ password: authPassword.value })
                        });
                        const data = await res.json();
                        if (data.success) {
                            authenticated.value = true;
                            authPassword.value = "";
                            // ç™»å½•æˆåŠŸååŠ è½½æ•°æ®
                            loadConfig();
                            loadModels();
                            loadStatus();
                            loadSubmitDelay();
                            loadWebPassword();
                            connectSSE();
                            apiCall("/api/quizzes/cache").then((d) => {
                                if (d) quizzes.value = d;
                            });
                            // å¯åŠ¨çŠ¶æ€è½®è¯¢å®šæ—¶å™¨
                            if (!statusInterval) {
                                statusInterval = setInterval(loadStatus, 2000);
                            }
                        } else {
                            authError.value = data.message || "å¯†ç é”™è¯¯";
                        }
                    } catch (e) {
                        authError.value = "ç™»å½•å¤±è´¥: " + e.message;
                    }
                    authLoading.value = false;
                };

                const loadConfig = async () => {
                    const data = await apiCall("/api/config");
                    config.maskedUser = data.masked_user || "Guest";
                    config.hasCookie = data.has_cookie;
                    if (data.user_name) configForm.user_name = data.user_name;
                };

                const saveConfig = async () => {
                    saving.value = true;
                    const data = await apiCall("/api/config/save", "POST", configForm);
                    if (data.success) {
                        showToast(data.message || "é…ç½®ä¿å­˜æˆåŠŸ");
                        addLog("é…ç½®å·²ä¿å­˜", "success");
                        configForm.password = "";
                        loadConfig();
                    } else {
                        showToast(data.message || "ä¿å­˜å¤±è´¥", "error");
                    }
                    saving.value = false;
                };

                const loadQuizzes = async () => {
                    loadingQuizzes.value = true;
                    const data = await apiCall("/api/quizzes");
                    quizzes.value = data || [];
                    loadingQuizzes.value = false;
                };

                const loadSubmitDelay = async () => {
                    try {
                        const data = await apiCall("/api/settings/submit-delay");
                        submitDelay.value = data.submit_delay || 0;
                    } catch (e) {
                        console.error("Failed to load submit delay:", e);
                    }
                };

                const saveSubmitDelay = async () => {
                    savingDelay.value = true;
                    try {
                        const data = await apiCall("/api/settings/submit-delay", "POST", {
                            submit_delay: submitDelay.value
                        });
                        if (data.success) {
                            showToast("å»¶è¿Ÿè®¾ç½®å·²ä¿å­˜");
                            addLog(`æäº¤å»¶è¿Ÿè®¾ç½®ä¸º ${submitDelay.value} ç§’`, "success");
                        } else {
                            showToast("ä¿å­˜å¤±è´¥", "error");
                        }
                    } catch (e) {
                        showToast("ä¿å­˜å¤±è´¥: " + e.message, "error");
                    }
                    savingDelay.value = false;
                };

                const loadWebPassword = async () => {
                    try {
                        const data = await apiCall("/api/settings/web-password");
                        hasWebPassword.value = data.has_password || false;
                    } catch (e) {
                        console.error("Failed to load web password status:", e);
                    }
                };

                const saveWebPassword = async () => {
                    if (!webPassword.value) {
                        showToast("è¯·è¾“å…¥å¯†ç ", "error");
                        return;
                    }
                    savingPassword.value = true;
                    try {
                        const data = await apiCall("/api/settings/web-password", "POST", {
                            password: webPassword.value
                        });
                        if (data.success) {
                            showToast(data.message);
                            addLog("Web è®¿é—®å¯†ç å·²æ›´æ–°", "success");
                            hasWebPassword.value = true;
                            webPassword.value = "";
                        } else {
                            showToast("ä¿å­˜å¤±è´¥", "error");
                        }
                    } catch (e) {
                        showToast("ä¿å­˜å¤±è´¥: " + e.message, "error");
                    }
                    savingPassword.value = false;
                };

                const clearWebPassword = async () => {
                    savingPassword.value = true;
                    try {
                        const data = await apiCall("/api/settings/web-password", "POST", {
                            password: ""
                        });
                        if (data.success) {
                            showToast("å¯†ç å·²æ¸…é™¤");
                            addLog("Web è®¿é—®å¯†ç å·²æ¸…é™¤", "success");
                            hasWebPassword.value = false;
                        }
                    } catch (e) {
                        showToast("æ“ä½œå¤±è´¥: " + e.message, "error");
                    }
                    savingPassword.value = false;
                };

                const loadModels = async () => {
                    const data = await apiCall("/api/models");
                    models.value = data.map((m) => ({ ...m, api_key: "" }));
                };

                const saveModels = async () => {
                    savingModels.value = true;
                    const data = await apiCall(
                        "/api/models/save",
                        "POST",
                        models.value
                    );
                    if (data.success) {
                        showToast(data.message || "æ¨¡å‹é…ç½®ä¿å­˜æˆåŠŸ");
                        addLog("æ¨¡å‹é…ç½®å·²æ›´æ–°", "success");
                    } else {
                        showToast(data.message || "ä¿å­˜å¤±è´¥", "error");
                    }
                    savingModels.value = false;
                };

                const testModel = async (idx) => {
                    const m = models.value[idx];
                    m.testing = true;
                    m.testMessage = "";
                    const res = await apiCall("/api/models/test", "POST", m);
                    m.testing = false;
                    m.testResult = res.success ? "success" : "error";
                    m.testMessage = res.message;
                };

                const startAnswer = async () => {
                    const body =
                        selectedQuiz.value.length > 0
                            ? { quizUrls: selectedQuiz.value }
                            : {};
                    const res = await apiCall("/api/start", "POST", body);
                    if (res.success) {
                        status.running = true;
                        addLog("ä»»åŠ¡é˜Ÿåˆ—å·²å¯åŠ¨", "info");
                    }
                };

                const stopAnswer = async () => {
                    await apiCall("/api/stop", "POST");
                    status.running = false;
                };

                const doLogin = async () => {
                    loggingIn.value = true;
                    const res = await apiCall("/api/login", "POST");
                    if (res.success) addLog("æ­£åœ¨å°è¯•ç™»å½•...", "info");
                    loggingIn.value = false;
                };

                const loadStatus = async () => {
                    const data = await apiCall("/api/status");
                    Object.assign(status, data);
                };

                // SSE é€»è¾‘
                const connectSSE = () => {
                    if (eventSource) eventSource.close();
                    eventSource = new EventSource("/api/events");
                    eventSource.onopen = () => (sseConnected.value = true);
                    eventSource.onmessage = (e) => {
                        const data = JSON.parse(e.data);
                        if (data.type === "connected") return;

                        // æ›´æ–°è¿›åº¦ï¼ˆåªåœ¨é log ç±»å‹äº‹ä»¶æ—¶æ›´æ–°ï¼Œå› ä¸º log äº‹ä»¶çš„è¿›åº¦å€¼æ— æ„ä¹‰ï¼‰
                        if (data.type !== "log") {
                            if (data.progress !== undefined) status.progress = data.progress;
                            if (data.total !== undefined) status.total = data.total;
                        }
                        if (data.message && data.type !== "quiz_completed") {
                            status.message = data.message;
                            addLog(data.message, data.type);
                        }
                        if (
                            data.type === "complete" ||
                            data.type === "error" ||
                            data.type === "cancelled"
                        ) {
                            status.running = false;
                            // å–æ¶ˆæ—¶é‡ç½®è¿›åº¦æ¡
                            if (data.type === "cancelled") {
                                status.progress = 0;
                                status.total = 0;
                                status.message = "ä»»åŠ¡å·²å–æ¶ˆ";
                            }
                            // å®Œæˆååˆ·æ–°ç¼“å­˜ï¼ˆä¸å¯åŠ¨æµè§ˆå™¨ï¼‰
                            if (data.type === "complete") {
                                apiCall("/api/quizzes/cache").then((d) => {
                                    if (d) quizzes.value = d;
                                });
                            }
                        }
                    };
                    eventSource.onerror = () => (sseConnected.value = false);
                };

                // è¾…åŠ©
                const addModel = () =>
                    models.value.push({
                        name: "New Model",
                        enabled: true,
                        base_url: "",
                        model: "",
                        api_key: "",
                    });
                const removeModel = (i) => models.value.splice(i, 1);
                const selectQuiz = (q) => {
                    const idx = selectedQuiz.value.indexOf(q.url);
                    if (idx === -1) {
                        selectedQuiz.value.push(q.url);
                    } else {
                        selectedQuiz.value.splice(idx, 1);
                    }
                };

                // åˆå§‹åŒ–
                onMounted(async () => {
                    // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
                    await checkAuth();

                    // å¦‚æœä¸éœ€è¦è®¤è¯æˆ–å·²è®¤è¯ï¼ŒåŠ è½½æ•°æ®
                    if (!authRequired.value || authenticated.value) {
                        loadConfig();
                        loadModels();
                        loadStatus();
                        loadSubmitDelay();
                        loadWebPassword();
                        connectSSE();
                        // è‡ªåŠ¨åŠ è½½ä¸€æ¬¡é¢˜åº“ç¼“å­˜
                        apiCall("/api/quizzes/cache").then((d) => {
                            if (d) quizzes.value = d;
                        });

                        statusInterval = setInterval(loadStatus, 2000);
                    }
                });

                onUnmounted(() => {
                    clearInterval(statusInterval);
                    if (eventSource) eventSource.close();
                });

                return {
                    tabs,
                    currentTab,
                    currentTabName,
                    theme,
                    toggleTheme,
                    config,
                    configForm,
                    status,
                    logs,
                    quizzes,
                    models,
                    groupedQuizzes,
                    progressPercent,
                    selectedQuizName,
                    logContainer,
                    loadingQuizzes,
                    saving,
                    savingModels,
                    loggingIn,
                    selectedQuiz,
                    sseConnected,
                    toast,
                    loadConfig,
                    saveConfig,
                    loadQuizzes,
                    loadModels,
                    saveModels,
                    addModel,
                    removeModel,
                    testModel,
                    startAnswer,
                    stopAnswer,
                    doLogin,
                    selectQuiz,
                    loadStatus,
                    submitDelay,
                    savingDelay,
                    saveSubmitDelay,
                    webPassword,
                    hasWebPassword,
                    savingPassword,
                    saveWebPassword,
                    clearWebPassword,
                    authRequired,
                    authenticated,
                    authPassword,
                    authLoading,
                    authError,
                    doAuthLogin,
                };
            },
        }).mount("#app");
    </script>
</body>

</html>